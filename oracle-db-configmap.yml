apiVersion: v1
kind: ConfigMap
metadata:
  name: oracle-db-configmap
data:
  xepdb1.sql: |-
    SELECT SYS_CONTEXT('USERENV', 'CON_NAME') AS CURRENT_CONTAINER FROM DUAL;
    ALTER SESSION SET CONTAINER = XEPDB1;

    CREATE USER dkuser IDENTIFIED BY dkpassword;
    GRANT CONNECT, RESOURCE TO dkuser;
    ALTER USER dkuser QUOTA UNLIMITED ON users;

    CREATE TABLE dkuser.generos (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        descripcion VARCHAR2(255) NOT NULL
    );

    CREATE TABLE dkuser.peliculas (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        titulo VARCHAR2(255) NOT NULL,
        director VARCHAR2(255) NOT NULL,
        duracion NUMBER NOT NULL,
        fecha_estreno DATE NOT NULL,
        id_genero NUMBER NOT NULL
    );

    CREATE TABLE dkuser.usuarios (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        username VARCHAR2(50) NOT NULL,
        pwd VARCHAR2(100) NOT NULL,
        estado NUMBER(1) DEFAULT 0 NOT NULL
    );

    CREATE TABLE dkuser.perfiles (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        descripcion VARCHAR2(50) NOT NULL
    );

    CREATE TABLE dkuser.usuarios_perfiles (
        id_usuario NUMBER NOT NULL,
        id_perfil NUMBER NOT NULL
    );

    CREATE TABLE dkuser.favoritos (
        id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        id_usuario NUMBER NOT NULL,
        id_pelicula NUMBER NOT NULL
    );

    ALTER TABLE dkuser.peliculas
    ADD CONSTRAINT fk_peliculas_generos
    FOREIGN KEY (id_genero)
    REFERENCES dkuser.generos(id);

    ALTER TABLE dkuser.usuarios_perfiles
    ADD CONSTRAINT fk_usuarios_perfiles_usuarios
    FOREIGN KEY (id_usuario)
    REFERENCES dkuser.usuarios(id);

    ALTER TABLE dkuser.usuarios_perfiles
    ADD CONSTRAINT fk_usuarios_perfiles_perfiles
    FOREIGN KEY (id_perfil)
    REFERENCES dkuser.perfiles(id);

    ALTER TABLE dkuser.favoritos
    ADD CONSTRAINT fk_favoritos_usuarios
    FOREIGN KEY (id_usuario)
    REFERENCES dkuser.usuarios(id);

    ALTER TABLE dkuser.favoritos
    ADD CONSTRAINT fk_favoritos_peliculas
    FOREIGN KEY (id_pelicula)
    REFERENCES dkuser.peliculas(id);